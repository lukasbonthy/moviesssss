<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Watch Party â€¢ Darkflix</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ["system-ui", "SF Pro Text", "Inter", "sans-serif"] },
          colors: { netflixBlack: "#141414", netflixRed: "#e50914" },
        },
      },
    };
  </script>
  <style>
    body { background:#000; }
    .noise {
      pointer-events:none;
      position:fixed;
      inset:0;
      opacity:0.16;
      mix-blend-mode:soft-light;
      background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 160 160' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='noStitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.45'/%3E%3C/svg%3E");
    }
  </style>
</head>
<body class="min-h-screen font-sans text-white antialiased bg-black">
  <div class="noise -z-10"></div>
  <div class="min-h-screen flex flex-col">
    <header class="fixed top-0 left-0 right-0 z-30 bg-gradient-to-b from-black via-black/80 to-transparent">
      <nav class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
        <div class="flex items-center gap-6">
          <a href="/movies" class="flex items-center">
            <span class="text-2xl md:text-3xl font-black tracking-tight text-netflixRed">
              DARKFLIX
            </span>
          </a>
          <div class="hidden md:flex flex-col leading-tight">
            <span id="roomNameHeader" class="text-sm font-semibold text-slate-100"></span>
            <span id="movieTitleHeader" class="text-xs text-slate-300"></span>
          </div>
        </div>
        <div class="flex items-center gap-3">
          <button id="copyLinkBtn"
                  class="hidden sm:inline-flex items-center gap-1 text-xs px-3 py-1.5 rounded bg-white/15 hover:bg-white/25 border border-white/10">
            Copy link
          </button>
          <% if (currentUser) { %>
            <a href="/profile"
               class="hidden sm:inline-flex items-center gap-2 text-xs text-slate-200 hover:text-white">
              <span class="inline-flex h-6 w-6 rounded bg-white/10 items-center justify-center text-[10px] font-semibold">
                <%= currentUser.name.charAt(0).toUpperCase() %>
              </span>
              <span><%= currentUser.name %></span>
            </a>
          <% } %>
          <button onclick="window.location.href='/movies'"
                  class="text-xs px-3 py-1.5 rounded bg-white/10 hover:bg-white/20 border border-white/10">
            Exit
          </button>
        </div>
      </nav>
    </header>

    <main class="flex-1 pt-20 pb-10">
      <section class="max-w-7xl mx-auto px-4">
        <div class="grid lg:grid-cols-[minmax(0,2.3fr)_minmax(0,1.1fr)] gap-5 items-start">
          <div class="space-y-3">
            <div class="relative rounded-lg overflow-hidden border border-white/10 bg-black shadow-[0_25px_80px_rgba(0,0,0,0.9)]">
              <div class="aspect-video md:aspect-[21/9] w-full bg-black">
                <iframe id="partyPlayer"
                        class="w-full h-full"
                        src=""
                        frameborder="0"
                        allowfullscreen
                        referrerpolicy="no-referrer"></iframe>
              </div>
              <div class="absolute inset-x-0 bottom-0 h-24 bg-gradient-to-t from-black/90 via-black/40 to-transparent pointer-events-none"></div>
            </div>
            <div class="flex items-center justify-between text-xs text-slate-300">
              <div class="flex flex-col gap-0.5">
                <span id="roomNameHeaderMobile" class="md:hidden font-semibold text-slate-100"></span>
                <span class="text-[11px] text-slate-400">
                  Server time â€¢ <span id="serverTimeDisplay">00:00</span>
                </span>
              </div>
              <span class="hidden sm:inline-flex items-center gap-2 text-[11px] text-slate-400">
                <span class="inline-flex h-2 w-2 rounded-full bg-emerald-400"></span>
                Watch party active
              </span>
            </div>
          </div>

          <aside class="bg-gradient-to-b from-[#18181f] to-[#090812] border border-white/10 rounded-xl p-3.5 flex flex-col max-h-[540px]">
            <div class="flex items-center justify-between mb-2">
              <div>
                <h2 class="text-sm font-semibold">Party chat</h2>
                <% if (currentUser) { %>
                  <p class="text-[11px] text-slate-400">
                    Youâ€™re chatting as <span class="text-slate-100 font-medium"><%= currentUser.name %></span>
                  </p>
                <% } else { %>
                  <p class="text-[11px] text-slate-400">
                    Log in to chat with others.
                  </p>
                <% } %>
              </div>
              <span class="text-[10px] px-2 py-0.5 rounded-full bg-white/10 text-slate-300">
                No spoilers ðŸ‘€
              </span>
            </div>

            <div id="chatMessages"
                 class="flex-1 overflow-y-auto space-y-2 text-xs pr-1 border border-white/5 rounded-lg p-2.5 bg-black/30">
            </div>

            <form id="chatForm" class="mt-3 flex gap-2">
              <input id="chatInput"
                     type="text"
                     maxlength="200"
                     placeholder="Say something..."
                     class="flex-1 bg-black/60 border border-white/15 rounded-full px-3.5 py-1.5 text-[11px] focus:outline-none focus:ring-1 focus:ring-netflixRed" />
              <button type="submit"
                      class="px-4 py-1.5 text-[11px] rounded-full bg-netflixRed hover:bg-[#f6121d] font-semibold">
                Send
              </button>
            </form>

            <p id="chatStatus" class="mt-1 text-[11px] text-slate-400 min-h-[14px]"></p>
          </aside>
        </div>

        <p id="globalStatus" class="mt-4 text-xs text-slate-400"></p>
      </section>
    </main>
  </div>

  <script>
    const currentUsername = "<%= currentUser ? currentUser.name.replace(/\"/g, '&quot;') : 'Guest' %>";
    const defaultProfilePicture = "https://via.placeholder.com/40x40.png?text=U";

    const partyPlayer = document.getElementById("partyPlayer");
    const roomNameHeader = document.getElementById("roomNameHeader");
    const roomNameHeaderMobile = document.getElementById("roomNameHeaderMobile");
    const movieTitleHeader = document.getElementById("movieTitleHeader");
    const serverTimeDisplay = document.getElementById("serverTimeDisplay");
    const chatMessagesEl = document.getElementById("chatMessages");
    const chatForm = document.getElementById("chatForm");
    const chatInput = document.getElementById("chatInput");
    const chatStatus = document.getElementById("chatStatus");
    const globalStatus = document.getElementById("globalStatus");
    const copyLinkBtn = document.getElementById("copyLinkBtn");

    const SYNC_INTERVAL = 5000;
    const CHAT_REFRESH_INTERVAL = 5000;

    function getRoomCode() {
      const params = new URLSearchParams(window.location.search);
      return params.get("code");
    }

    function formatTime(seconds) {
      const s = Math.max(0, Math.floor(seconds));
      const m = Math.floor(s / 60);
      const h = Math.floor(m / 60);
      const ss = (s % 60).toString().padStart(2, "0");
      const mm = (m % 60).toString().padStart(2, "0");
      if (h > 0) return `${h}:${mm}:${ss}`;
      return `${mm}:${ss}`;
    }

    function setGlobalStatus(msg) {
      globalStatus.textContent = msg || "";
    }

    function displayChatMessage({ username, profilePicture, message }) {
      const wrapper = document.createElement("div");
      wrapper.className = "flex items-start gap-2";

      const avatar = document.createElement("div");
      avatar.className = "w-7 h-7 rounded-full bg-slate-700 flex items-center justify-center text-[10px] font-semibold flex-shrink-0 overflow-hidden";
      if (profilePicture) {
        const img = document.createElement("img");
        img.src = profilePicture;
        img.alt = username;
        img.className = "w-full h-full object-cover";
        avatar.appendChild(img);
      } else {
        avatar.textContent = (username || "?").charAt(0).toUpperCase();
      }

      const content = document.createElement("div");
      const nameEl = document.createElement("div");
      nameEl.className = "text-[11px] font-semibold text-slate-100";
      nameEl.textContent = username || "User";

      const msgEl = document.createElement("div");
      msgEl.className = "text-[11px] text-slate-200";
      msgEl.textContent = message;

      content.appendChild(nameEl);
      content.appendChild(msgEl);

      wrapper.appendChild(avatar);
      wrapper.appendChild(content);

      chatMessagesEl.appendChild(wrapper);
      chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
    }

    function loadChatMessages(chat) {
      chatMessagesEl.innerHTML = "";
      chat.forEach(displayChatMessage);
    }

    async function fetchRoomDetails() {
      const code = getRoomCode();
      if (!code) {
        setGlobalStatus("No room code found in URL.");
        return;
      }
      try {
        const res = await fetch(`/room-details/${code}`);
        if (!res.ok) throw new Error("Room not found");
        const data = await res.json();
        if (!data.videoUrl) {
          setGlobalStatus("This room has no video URL configured.");
          return;
        }
        partyPlayer.src = data.videoUrl;
        const roomName = data.roomName || `Room ${code}`;
        roomNameHeader.textContent = roomName;
        roomNameHeaderMobile.textContent = roomName;
        movieTitleHeader.textContent = data.movieTitle || "";
        if (data.chat) loadChatMessages(data.chat);
        setGlobalStatus("");
      } catch (err) {
        console.error(err);
        setGlobalStatus("Failed to load room details.");
      }
    }

    async function syncServerTime() {
      const code = getRoomCode();
      if (!code) return;
      try {
        const res = await fetch(`/time/${code}`);
        if (!res.ok) return;
        const data = await res.json();
        serverTimeDisplay.textContent = formatTime(data.currentTime || 0);
      } catch (err) {
        console.error("Time sync error", err);
      }
    }

    async function refreshChat() {
      const code = getRoomCode();
      if (!code) return;
      try {
        const res = await fetch(`/room-details/${code}`);
        if (!res.ok) return;
        const data = await res.json();
        if (data.chat) loadChatMessages(data.chat);
      } catch (err) {
        console.error("Chat refresh error", err);
      }
    }

    async function sendChatMessage(message) {
      const code = getRoomCode();
      if (!code) return;
      const profilePicture = defaultProfilePicture;
      try {
        const res = await fetch(`/send-message/${code}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username: currentUsername, profilePicture, message }),
        });
        const data = await res.json();
        if (data.success) {
          displayChatMessage({ username: currentUsername, profilePicture, message });
          chatInput.value = "";
          chatStatus.textContent = "";
        } else if (data.error) {
          chatStatus.textContent = data.error;
        } else {
          chatStatus.textContent = "Failed to send message.";
        }
      } catch (err) {
        console.error(err);
        chatStatus.textContent = "Failed to send message.";
      }
    }

    chatForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const msg = chatInput.value.trim();
      if (!msg) return;
      if (!currentUsername || currentUsername === "Guest") {
        chatStatus.textContent = "You must be logged in to chat.";
        return;
      }
      sendChatMessage(msg);
    });

    if (copyLinkBtn) {
      copyLinkBtn.addEventListener("click", async () => {
        const code = getRoomCode();
        if (!code) return;
        const url = new URL(window.location.href);
        url.searchParams.set("code", code);
        try {
          await navigator.clipboard.writeText(url.toString());
          copyLinkBtn.textContent = "Copied!";
          setTimeout(() => (copyLinkBtn.textContent = "Copy link"), 1500);
        } catch (err) {
          console.error("Copy failed", err);
          alert("Could not copy link");
        }
      });
    }

    (async function init() {
      await fetchRoomDetails();
      syncServerTime();
      setInterval(syncServerTime, SYNC_INTERVAL);
      setInterval(refreshChat, CHAT_REFRESH_INTERVAL);
    })();
  </script>
</body>
</html>
