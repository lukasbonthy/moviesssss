<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <title>StreamRealm+ • Movies</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ["system-ui","-apple-system","Segoe UI","Inter","Roboto","Helvetica","Arial","sans-serif"],
          },
          colors: {
            ink: "#05060b",
            ink2: "#070a12",
            panel: "#0b1020",
            panel2: "#0c1224",
            edge: "rgba(255,255,255,.10)",
            edge2: "rgba(255,255,255,.14)",
            glow: "#22d3ee",
            glow2: "#60a5fa",
            textSoft: "rgba(226,232,240,.82)",
            textSofter: "rgba(226,232,240,.65)",
          },
          boxShadow: {
            deep: "0 40px 120px rgba(0,0,0,.85)",
            lift: "0 24px 60px rgba(0,0,0,.75)",
            soft: "0 12px 30px rgba(0,0,0,.55)",
          },
          borderRadius: {
            "4xl": "2rem",
            "5xl": "2.5rem",
          },
          keyframes: {
            "fade-up": { "0%": { opacity: 0, transform: "translateY(14px)" }, "100%": { opacity: 1, transform: "translateY(0)" } },
            "fade-in": { "0%": { opacity: 0 }, "100%": { opacity: 1 } },
            "spin-slow": { "0%": { transform: "rotate(0deg)" }, "100%": { transform: "rotate(360deg)" } },
            "pulse-soft": { "0%,100%": { opacity: .4 }, "50%": { opacity: 1 } },
            "shine": { "0%": { transform: "translateX(-120%)" }, "100%": { transform: "translateX(120%)" } },
            "hero-xfade": { "0%": { opacity: 0 }, "100%": { opacity: 1 } },
          },
          animation: {
            "fade-up": "fade-up .5s ease-out forwards",
            "fade-in": "fade-in .35s ease-out forwards",
            "spin-slow": "spin-slow 1.15s linear infinite",
            "pulse-soft": "pulse-soft 2.2s ease-in-out infinite",
            "shine": "shine 1.3s ease-in-out infinite",
            "hero-xfade": "hero-xfade .55s ease-out forwards",
          },
        },
      },
    };
  </script>

  <style>
    body{
      background:
        radial-gradient(circle at 10% 0%, rgba(34,211,238,.18), transparent 55%),
        radial-gradient(circle at 90% 0%, rgba(96,165,250,.20), transparent 55%),
        radial-gradient(circle at 40% 90%, rgba(59,130,246,.10), transparent 55%),
        #05060b;
    }
    .row-scroll{ scrollbar-width:none; }
    .row-scroll::-webkit-scrollbar{ display:none; }

    .noise-layer{
      pointer-events:none;
      position:fixed; inset:0;
      opacity:.18;
      mix-blend-mode:soft-light;
      background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 160 160' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.95' numOctaves='4' stitchTiles='noStitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.4'/%3E%3C/svg%3E");
    }

    /* gradient border helper */
    .g-border{
      position:relative;
      border-radius: 2rem;
      overflow:hidden;
    }
    .g-border::before{
      content:"";
      position:absolute; inset:0;
      padding:1px;
      border-radius:2rem;
      background:linear-gradient(135deg, rgba(34,211,238,.35), rgba(96,165,250,.18), rgba(255,255,255,.10));
      -webkit-mask:linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite:xor;
      mask-composite:exclude;
      pointer-events:none;
    }

    /* text clamp */
    .clamp-2{
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
    }
    .clamp-3{
      display:-webkit-box;
      -webkit-line-clamp:3;
      -webkit-box-orient:vertical;
      overflow:hidden;
    }
  </style>
</head>

<body class="min-h-screen font-sans text-white antialiased">
  <div class="noise-layer -z-10"></div>

  <!-- LOADER -->
  <div id="appLoader" class="fixed inset-0 z-[80] flex flex-col items-center justify-center bg-ink transition-opacity duration-500">
    <div class="relative mb-6">
      <div class="w-40 h-40 rounded-full bg-gradient-to-br from-glow/25 via-transparent to-glow2/25 blur-3xl opacity-90"></div>
      <div class="absolute inset-0 flex items-center justify-center">
        <div class="w-16 h-16 rounded-full border-[3px] border-white/10 border-t-glow animate-spin-slow"></div>
      </div>
    </div>
    <div class="flex flex-col items-center gap-1 animate-pulse-soft">
      <div class="text-2xl font-semibold tracking-tight">
        StreamRealm<span class="text-glow align-super text-sm">+</span>
      </div>
      <p class="text-xs text-slate-300 uppercase tracking-[0.26em]">Loading library</p>
    </div>
  </div>

  <!-- TOP NAV -->
  <header class="sticky top-0 z-40 backdrop-blur-xl bg-black/35 border-b border-white/5">
    <div class="max-w-[1600px] mx-auto px-4 md:px-8 py-4 flex items-center gap-4">
      <a href="/movies" class="flex items-center gap-3 group">
        <div class="h-10 w-10 rounded-2xl bg-gradient-to-br from-glow to-glow2 flex items-center justify-center text-[12px] font-black text-black shadow-soft">
          SR
        </div>
        <div class="leading-tight">
          <div class="text-lg md:text-xl font-semibold tracking-tight">StreamRealm<span class="text-glow">+</span></div>
          <div class="text-[11px] text-textSofter -mt-0.5">Movies • Series • Originals</div>
        </div>
        <div class="hidden md:block ml-3 h-[18px] w-[1px] bg-white/10"></div>
      </a>

      <!-- nav pills -->
      <nav class="hidden md:flex items-center gap-2">
        <a href="/movies" class="px-4 py-2 rounded-full bg-white text-black text-xs font-semibold">Movies</a>
        <a href="/tv" class="px-4 py-2 rounded-full bg-white/5 hover:bg-white/10 text-xs font-semibold text-slate-200 border border-white/10">Series</a>
        <button type="button" class="px-4 py-2 rounded-full bg-white/5 hover:bg-white/10 text-xs font-semibold text-slate-200 border border-white/10">Originals</button>
      </nav>

      <div class="flex-1"></div>

      <!-- search -->
      <form id="searchForm" class="hidden md:flex items-center gap-2 rounded-full bg-white/5 border border-white/10 px-4 py-2">
        <svg class="w-4 h-4 text-slate-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 100-15 7.5 7.5 0 000 15z"/>
        </svg>
        <input id="searchInput" type="text" placeholder="Search movies…" class="bg-transparent outline-none text-sm placeholder:text-slate-400 w-56" />
        <kbd class="text-[10px] text-slate-400 border border-white/10 rounded px-1.5 py-0.5">Enter</kbd>
      </form>

      <button id="mobileSearchBtn" class="md:hidden h-10 w-10 rounded-full bg-white/5 border border-white/10 flex items-center justify-center">
        <svg class="w-5 h-5 text-slate-200" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 100-15 7.5 7.5 0 000 15z"/>
        </svg>
      </button>

      <!-- user -->
      <% if (currentUser) { %>
        <div class="relative group">
          <button type="button" class="flex items-center gap-3 rounded-full bg-white/5 border border-white/10 px-3 py-2 hover:bg-white/10 transition">
            <span class="h-9 w-9 rounded-full bg-white/10 border border-white/10 grid place-items-center text-sm font-semibold">
              <%= currentUser.name.charAt(0).toUpperCase() %>
            </span>
            <div class="hidden sm:block text-left">
              <div class="text-sm font-semibold leading-tight"><%= currentUser.name %></div>
              <div class="text-[11px] text-textSofter -mt-0.5">Premium</div>
            </div>
            <svg class="w-4 h-4 text-slate-300 hidden sm:block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
            </svg>
          </button>

          <div class="absolute right-0 mt-2 w-48 rounded-2xl bg-black/80 backdrop-blur-xl border border-white/10 shadow-deep opacity-0 scale-95 pointer-events-none group-hover:opacity-100 group-hover:scale-100 group-hover:pointer-events-auto transition origin-top-right">
            <a href="/profile" class="block px-4 py-3 text-sm hover:bg-white/10 rounded-t-2xl">Account</a>
            <a href="/tv" class="block px-4 py-3 text-sm hover:bg-white/10">Series</a>
            <div class="border-t border-white/10"></div>
            <form action="/logout" method="POST">
              <button type="submit" class="w-full text-left px-4 py-3 text-sm text-red-200 hover:bg-white/10 rounded-b-2xl">Sign out</button>
            </form>
          </div>
        </div>
      <% } else { %>
        <a href="/login" class="px-5 py-2.5 rounded-full bg-white text-black font-semibold text-sm hover:bg-slate-100">Log in</a>
      <% } %>
    </div>
  </header>

  <!-- MAIN -->
  <main class="max-w-[1600px] mx-auto px-4 md:px-8 py-8 md:py-10 space-y-10">

    <!-- HERO (two big cards) -->
    <section class="space-y-4">
      <div class="flex items-center justify-between">
        <div>
          <div class="text-[12px] uppercase tracking-[0.32em] text-slate-400">Now streaming</div>
          <div class="text-2xl md:text-3xl font-bold tracking-tight">Featured picks</div>
        </div>

        <div class="hidden md:flex items-center gap-2 text-sm text-textSofter">
          <span class="h-2 w-2 rounded-full bg-glow"></span>
          <span id="heroHint">Auto-rotating</span>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-5 md:gap-6">
        <!-- HERO A -->
        <article id="heroA" class="g-border rounded-4xl bg-white/5 border border-white/10 shadow-lift overflow-hidden relative min-h-[320px] md:min-h-[380px]">
          <div id="heroABg" class="absolute inset-0 bg-cover bg-center opacity-80"></div>
          <div class="absolute inset-0 bg-gradient-to-r from-black/85 via-black/55 to-transparent"></div>
          <div class="absolute inset-0 bg-gradient-to-t from-black/65 via-transparent to-black/25"></div>

          <div class="relative z-10 p-6 md:p-8 h-full flex flex-col justify-between">
            <div class="space-y-2">
              <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-black/35 border border-white/15 text-xs text-slate-200">
                <span class="h-2 w-2 rounded-full bg-emerald-400 animate-pulse"></span>
                Featured
              </div>
              <h1 id="heroATitle" class="text-3xl md:text-4xl font-extrabold leading-tight drop-shadow">Loading…</h1>
              <div id="heroAMeta" class="text-sm text-textSoft"></div>
              <p id="heroAOverview" class="hidden sm:block text-sm md:text-[15px] text-textSoft clamp-3 max-w-2xl"></p>
            </div>

            <div class="flex flex-wrap items-center gap-3 pt-4">
              <button id="heroAPlay" class="px-5 py-3 rounded-full bg-white text-black font-semibold text-sm hover:bg-slate-100 flex items-center gap-2 shadow-soft">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M6 4.5v11l8-5.5-8-5.5z"/></svg>
                Play
              </button>
              <button id="heroADetails" class="px-5 py-3 rounded-full bg-white/10 border border-white/15 text-white font-semibold text-sm hover:bg-white/15">
                Details
              </button>
              <button id="heroAWatchlist" class="px-5 py-3 rounded-full bg-white/5 border border-white/10 text-white font-semibold text-sm hover:bg-white/10">
                + Watchlist
              </button>
            </div>
          </div>
        </article>

        <!-- HERO B -->
        <article id="heroB" class="g-border rounded-4xl bg-white/5 border border-white/10 shadow-lift overflow-hidden relative min-h-[320px] md:min-h-[380px]">
          <div id="heroBBg" class="absolute inset-0 bg-cover bg-center opacity-80"></div>
          <div class="absolute inset-0 bg-gradient-to-r from-black/80 via-black/40 to-transparent"></div>
          <div class="absolute inset-0 bg-gradient-to-t from-black/70 via-transparent to-black/20"></div>

          <div class="relative z-10 p-6 md:p-8 h-full flex flex-col justify-between">
            <div class="space-y-2">
              <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-black/35 border border-white/15 text-xs text-slate-200">
                <span class="h-2 w-2 rounded-full bg-glow"></span>
                Next up
              </div>
              <h2 id="heroBTitle" class="text-3xl md:text-4xl font-extrabold leading-tight drop-shadow">Loading…</h2>
              <div id="heroBMeta" class="text-sm text-textSoft"></div>
              <p id="heroBOverview" class="hidden sm:block text-sm md:text-[15px] text-textSoft clamp-3 max-w-2xl"></p>
            </div>

            <div class="flex flex-wrap items-center gap-3 pt-4">
              <button id="heroBPlay" class="px-5 py-3 rounded-full bg-white text-black font-semibold text-sm hover:bg-slate-100 flex items-center gap-2 shadow-soft">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M6 4.5v11l8-5.5-8-5.5z"/></svg>
                Play
              </button>
              <button id="heroBDetails" class="px-5 py-3 rounded-full bg-white/10 border border-white/15 text-white font-semibold text-sm hover:bg-white/15">
                Details
              </button>
              <button id="heroBWatchlist" class="px-5 py-3 rounded-full bg-white/5 border border-white/10 text-white font-semibold text-sm hover:bg-white/10">
                + Watchlist
              </button>
            </div>
          </div>
        </article>
      </div>

      <!-- hero carousel thumbnails -->
      <div class="flex items-center justify-between pt-2">
        <div class="text-sm text-textSofter">Up next</div>
        <div class="text-xs text-textSofter hidden md:block">Tip: scroll rails with Shift + mouse wheel</div>
      </div>
      <div id="heroStrip" class="row-scroll flex gap-3 overflow-x-auto pb-2 snap-x snap-mandatory">
        <!-- injected -->
      </div>
    </section>

    <!-- GENRES -->
    <section class="space-y-3">
      <div class="flex items-center justify-between">
        <div class="text-lg md:text-xl font-bold tracking-tight">Browse by genre</div>
        <div class="flex items-center gap-2">
          <button id="clearGenreBtn" class="hidden px-4 py-2 rounded-full bg-white/5 border border-white/10 text-sm text-slate-200 hover:bg-white/10">
            Clear filter
          </button>
        </div>
      </div>

      <div id="genrePills" class="row-scroll flex gap-2 overflow-x-auto pb-2">
        <!-- injected -->
      </div>

      <p id="statusMessage" class="hidden text-sm text-textSofter"></p>
    </section>

    <!-- SEARCH RESULTS -->
    <section id="searchSection" class="hidden space-y-3">
      <div class="flex items-center justify-between">
        <div>
          <div id="searchTitle" class="text-lg font-bold"></div>
          <div class="text-sm text-textSofter">Results matched from TMDB</div>
        </div>
        <button id="clearSearchBtn" class="px-4 py-2 rounded-full bg-white/5 border border-white/10 text-sm hover:bg-white/10">Clear</button>
      </div>
      <div id="searchRow" class="row-scroll flex gap-4 overflow-x-auto pb-2 snap-x snap-mandatory"></div>
    </section>

    <!-- ROWS -->
    <section id="rowsContainer" class="space-y-10"></section>

    <div class="pb-10"></div>
  </main>

  <!-- DETAILS MODAL -->
  <div id="detailsModal" class="fixed inset-0 z-[90] hidden">
    <div id="modalBackdrop" class="absolute inset-0 bg-black/70 backdrop-blur-sm"></div>

    <div class="relative max-w-[1100px] mx-auto px-4 md:px-8 py-8 md:py-12">
      <div class="g-border rounded-5xl bg-black/75 border border-white/10 shadow-deep overflow-hidden">
        <div id="modalHero" class="relative min-h-[260px] md:min-h-[320px]">
          <div id="modalHeroBg" class="absolute inset-0 bg-cover bg-center opacity-75"></div>
          <div class="absolute inset-0 bg-gradient-to-r from-black/90 via-black/55 to-transparent"></div>
          <div class="absolute inset-0 bg-gradient-to-t from-black/75 via-transparent to-black/25"></div>

          <button id="modalClose" class="absolute top-4 right-4 h-11 w-11 rounded-full bg-black/40 border border-white/15 hover:bg-black/60 grid place-items-center">
            <svg class="w-5 h-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>

          <div class="relative z-10 p-6 md:p-8 pt-14 md:pt-16 flex gap-6">
            <div class="hidden sm:block w-40 md:w-52 flex-shrink-0">
              <div class="rounded-3xl overflow-hidden border border-white/10 bg-white/5 shadow-soft">
                <img id="modalPoster" src="" alt="Poster" class="w-full aspect-[2/3] object-cover"/>
              </div>
            </div>

            <div class="flex-1 space-y-3">
              <div class="text-[12px] uppercase tracking-[0.32em] text-slate-300">Movie details</div>
              <h3 id="modalTitle" class="text-2xl md:text-4xl font-extrabold leading-tight">Title</h3>
              <div id="modalMeta" class="text-sm text-textSoft"></div>
              <p id="modalOverview" class="text-sm md:text-[15px] text-textSoft clamp-3 max-w-3xl"></p>

              <div class="flex flex-wrap items-center gap-3 pt-2">
                <button id="modalPlayBtn" class="px-5 py-3 rounded-full bg-white text-black font-semibold text-sm hover:bg-slate-100 flex items-center gap-2 shadow-soft">
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M6 4.5v11l8-5.5-8-5.5z"/></svg>
                  Play
                </button>
                <button id="modalWatchlistBtn" class="px-5 py-3 rounded-full bg-white/10 border border-white/15 text-white font-semibold text-sm hover:bg-white/15">
                  + Watchlist
                </button>
              </div>
            </div>
          </div>
        </div>

        <div class="p-6 md:p-8 space-y-5">
          <div>
            <div class="text-sm font-semibold text-slate-100 mb-2">Top cast</div>
            <div id="modalCast" class="row-scroll flex gap-3 overflow-x-auto pb-2"></div>
          </div>

          <div class="border-t border-white/10 pt-5">
            <div class="text-sm font-semibold text-slate-100 mb-2">More like this</div>
            <div id="modalSimilar" class="row-scroll flex gap-4 overflow-x-auto pb-2 snap-x snap-mandatory"></div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <script>
    // =========================
    // CONFIG
    // =========================
    const TMDB_API_KEY = "<%= tmdbApiKey %>";
    const TMDB_BASE = "https://api.themoviedb.org/3";
    const IMG_W500 = "https://image.tmdb.org/t/p/w500";
    const IMG_ORIG = "https://image.tmdb.org/t/p/original";

    const CATEGORIES = [
      { key: "trending", title: "Trending now", path: "/trending/movie/week" },
      { key: "popular", title: "Popular", path: "/movie/popular" },
      { key: "top_rated", title: "Top rated", path: "/movie/top_rated" },
      { key: "now_playing", title: "In theatres", path: "/movie/now_playing" },
      { key: "upcoming", title: "Coming soon", path: "/movie/upcoming" },
    ];

    // =========================
    // DOM
    // =========================
    const appLoader = document.getElementById("appLoader");
    const heroABg = document.getElementById("heroABg");
    const heroBBg = document.getElementById("heroBBg");
    const heroATitle = document.getElementById("heroATitle");
    const heroBTitle = document.getElementById("heroBTitle");
    const heroAMeta = document.getElementById("heroAMeta");
    const heroBMeta = document.getElementById("heroBMeta");
    const heroAOverview = document.getElementById("heroAOverview");
    const heroBOverview = document.getElementById("heroBOverview");
    const heroAPlay = document.getElementById("heroAPlay");
    const heroBPlay = document.getElementById("heroBPlay");
    const heroADetails = document.getElementById("heroADetails");
    const heroBDetails = document.getElementById("heroBDetails");
    const heroAWatchlist = document.getElementById("heroAWatchlist");
    const heroBWatchlist = document.getElementById("heroBWatchlist");
    const heroStrip = document.getElementById("heroStrip");
    const heroHint = document.getElementById("heroHint");

    const rowsContainer = document.getElementById("rowsContainer");
    const statusMessage = document.getElementById("statusMessage");

    const genrePills = document.getElementById("genrePills");
    const clearGenreBtn = document.getElementById("clearGenreBtn");

    const searchForm = document.getElementById("searchForm");
    const searchInput = document.getElementById("searchInput");
    const mobileSearchBtn = document.getElementById("mobileSearchBtn");
    const searchSection = document.getElementById("searchSection");
    const searchTitle = document.getElementById("searchTitle");
    const searchRow = document.getElementById("searchRow");
    const clearSearchBtn = document.getElementById("clearSearchBtn");

    // modal
    const detailsModal = document.getElementById("detailsModal");
    const modalBackdrop = document.getElementById("modalBackdrop");
    const modalClose = document.getElementById("modalClose");
    const modalHeroBg = document.getElementById("modalHeroBg");
    const modalPoster = document.getElementById("modalPoster");
    const modalTitle = document.getElementById("modalTitle");
    const modalMeta = document.getElementById("modalMeta");
    const modalOverview = document.getElementById("modalOverview");
    const modalCast = document.getElementById("modalCast");
    const modalSimilar = document.getElementById("modalSimilar");
    const modalPlayBtn = document.getElementById("modalPlayBtn");
    const modalWatchlistBtn = document.getElementById("modalWatchlistBtn");

    // =========================
    // STATE
    // =========================
    const state = {
      genres: [],            // {id, name}
      genreId: null,
      trending: [],
      heroIndex: 0,
      heroTimer: null,
      reducedMotion: window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches,
      watchlist: new Set(),
    };

    // =========================
    // UTILS
    // =========================
    function esc(s){
      if (!s) return "";
      return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");
    }

    function setStatus(text, show=true){
      statusMessage.textContent = text;
      statusMessage.classList.toggle("hidden", !show);
    }

    async function fetchJson(url){
      const res = await fetch(url);
      if(!res.ok) throw new Error("Network error");
      return res.json();
    }

    function hideLoader(){
      appLoader.classList.add("opacity-0","pointer-events-none");
      setTimeout(()=>{ appLoader.style.display="none"; }, 520);
    }

    function getYear(item){
      const d = item.release_date || item.first_air_date || "";
      return d ? d.split("-")[0] : "";
    }

    function rating(item){
      const v = item.vote_average || 0;
      return v ? v.toFixed(1) : "";
    }

    function imgBackdrop(item){
      const p = item.backdrop_path || item.poster_path;
      return p ? IMG_ORIG + p : "";
    }

    function imgPoster(item){
      const p = item.poster_path || item.backdrop_path;
      return p ? IMG_W500 + p : "";
    }

    function goToWatchMovie(tmdbId){
      const url = new URL("/watch", window.location.origin);
      url.searchParams.set("type","movie");
      url.searchParams.set("tmdbId", tmdbId);
      window.location.href = url.toString();
    }

    function loadWatchlist(){
      try{
        const raw = localStorage.getItem("sr_watchlist_movies");
        if(!raw) return;
        const arr = JSON.parse(raw);
        if(Array.isArray(arr)) arr.forEach(id => state.watchlist.add(Number(id)));
      } catch {}
    }

    function saveWatchlist(){
      try{
        localStorage.setItem("sr_watchlist_movies", JSON.stringify([...state.watchlist]));
      } catch {}
    }

    function toggleWatchlist(id){
      const num = Number(id);
      if(state.watchlist.has(num)) state.watchlist.delete(num);
      else state.watchlist.add(num);
      saveWatchlist();
    }

    function watchlistLabel(id){
      return state.watchlist.has(Number(id)) ? "✓ In Watchlist" : "+ Watchlist";
    }

    // =========================
    // UI: CARDS
    // =========================
    function createPosterCard(item){
      const id = item.id;
      const title = item.title || item.name || "Untitled";
      const year = getYear(item);
      const rate = rating(item);
      const poster = imgPoster(item) || "https://via.placeholder.com/400x600/0b1020/ffffff?text=No+Image";

      const el = document.createElement("article");
      el.className = "snap-start group relative flex-shrink-0 w-[140px] sm:w-[160px] md:w-[180px] lg:w-[200px] cursor-pointer";

      el.innerHTML = `
        <div class="relative rounded-4xl overflow-hidden bg-white/5 border border-white/10 shadow-soft
                    transition-transform duration-300 group-hover:-translate-y-2 group-hover:scale-[1.03]">
          <img src="${poster}" alt="${esc(title)}" class="w-full aspect-[2/3] object-cover" />
          <div class="absolute inset-0 bg-gradient-to-t from-black/85 via-black/25 to-transparent opacity-95"></div>

          <div class="absolute top-3 left-3 flex items-center gap-2">
            ${rate ? `<span class="px-2.5 py-1 rounded-full bg-black/50 border border-white/15 text-xs text-slate-100">★ ${rate}</span>` : ""}
            ${year ? `<span class="px-2.5 py-1 rounded-full bg-black/40 border border-white/10 text-xs text-slate-200">${esc(year)}</span>` : ""}
          </div>

          <div class="absolute bottom-3 left-3 right-3">
            <div class="text-sm font-semibold leading-snug line-clamp-2">${esc(title)}</div>
            <div class="mt-2 flex items-center justify-between gap-2 opacity-0 translate-y-2 group-hover:opacity-100 group-hover:translate-y-0 transition duration-300">
              <button class="js-play px-3 py-2 rounded-full bg-white text-black text-xs font-semibold flex items-center gap-2">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M6 4.5v11l8-5.5-8-5.5z"/></svg>
                Play
              </button>
              <button class="js-info px-3 py-2 rounded-full bg-white/10 border border-white/15 text-white text-xs font-semibold">Info</button>
            </div>
          </div>
        </div>
      `;

      el.addEventListener("click", (e) => {
        const t = e.target;
        if (t && t.closest(".js-info")) return openDetails(id);
        if (t && t.closest(".js-play")) return goToWatchMovie(id);
        // clicking card opens details for a premium vibe
        openDetails(id);
      });

      return el;
    }

    function createMiniHeroThumb(item, index){
      const id = item.id;
      const poster = imgPoster(item) || "https://via.placeholder.com/300x450/0b1020/ffffff?text=No+Image";
      const title = item.title || item.name || "Untitled";

      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "snap-start relative flex-shrink-0 w-[110px] sm:w-[120px] md:w-[135px] rounded-4xl overflow-hidden border border-white/10 bg-white/5 shadow-soft hover:-translate-y-1 transition";
      btn.innerHTML = `
        <img src="${poster}" alt="${esc(title)}" class="w-full aspect-[2/3] object-cover"/>
        <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/20 to-transparent"></div>
        <div class="absolute bottom-2 left-2 right-2 text-[11px] text-slate-100 clamp-2 text-left">${esc(title)}</div>
        <div class="absolute top-2 right-2 text-[10px] px-2 py-1 rounded-full bg-black/45 border border-white/10 text-slate-200">#${index+1}</div>
      `;
      btn.addEventListener("click", () => {
        state.heroIndex = index;
        renderHeroes();
        // scroll top a bit for focus
        window.scrollTo({ top: 0, behavior: "smooth" });
      });
      return btn;
    }

    // =========================
    // HERO
    // =========================
    function buildMeta(item){
      const bits = [];
      const r = rating(item); if(r) bits.push(`★ ${r}`);
      const y = getYear(item); if(y) bits.push(y);
      bits.push("Movie");
      return bits.join("  •  ");
    }

    function setHeroCard(which, item){
      const bgEl = which === "A" ? heroABg : heroBBg;
      const tEl = which === "A" ? heroATitle : heroBTitle;
      const mEl = which === "A" ? heroAMeta : heroBMeta;
      const oEl = which === "A" ? heroAOverview : heroBOverview;
      const playBtn = which === "A" ? heroAPlay : heroBPlay;
      const detailsBtn = which === "A" ? heroADetails : heroBDetails;
      const wlBtn = which === "A" ? heroAWatchlist : heroBWatchlist;

      const bg = imgBackdrop(item);
      bgEl.style.backgroundImage = bg ? `url(${bg})` : "none";
      bgEl.classList.remove("animate-hero-xfade");
      void bgEl.offsetWidth;
      bgEl.classList.add("animate-hero-xfade");

      const title = item.title || item.name || "Untitled";
      tEl.textContent = title;
      mEl.textContent = buildMeta(item);
      oEl.textContent = item.overview || "";

      playBtn.onclick = () => goToWatchMovie(item.id);
      detailsBtn.onclick = () => openDetails(item.id);

      wlBtn.textContent = watchlistLabel(item.id);
      wlBtn.onclick = () => {
        toggleWatchlist(item.id);
        wlBtn.textContent = watchlistLabel(item.id);
      };
    }

    function renderHeroes(){
      if(!state.trending.length) return;
      const i = state.heroIndex % state.trending.length;
      const a = state.trending[i];
      const b = state.trending[(i+1) % state.trending.length];

      setHeroCard("A", a);
      setHeroCard("B", b);

      // strip
      heroStrip.innerHTML = "";
      state.trending.slice(0, 12).forEach((m, idx) => heroStrip.appendChild(createMiniHeroThumb(m, idx)));
    }

    function startHeroAutoRotate(){
      if(state.reducedMotion){
        heroHint.textContent = "Reduced motion";
        return;
      }
      heroHint.textContent = "Auto-rotating";
      if(state.heroTimer) clearInterval(state.heroTimer);
      state.heroTimer = setInterval(() => {
        state.heroIndex = (state.heroIndex + 1) % Math.max(1, state.trending.length);
        renderHeroes();
      }, 9000);
    }

    // =========================
    // GENRES + FILTER
    // =========================
    function pillButton(label, active=false){
      const b = document.createElement("button");
      b.type="button";
      b.className = `
        px-4 py-2 rounded-full text-sm font-semibold whitespace-nowrap
        border transition
        ${active ? "bg-white text-black border-white" : "bg-white/5 text-slate-200 border-white/10 hover:bg-white/10"}
      `.trim();
      b.textContent = label;
      return b;
    }

    function renderGenrePills(){
      genrePills.innerHTML = "";

      const allBtn = pillButton("All", state.genreId === null);
      allBtn.addEventListener("click", async () => {
        state.genreId = null;
        clearGenreBtn.classList.add("hidden");
        renderGenrePills();
        await reloadRows();
      });
      genrePills.appendChild(allBtn);

      state.genres.forEach(g => {
        const b = pillButton(g.name, state.genreId === g.id);
        b.addEventListener("click", async () => {
          state.genreId = g.id;
          clearGenreBtn.classList.remove("hidden");
          renderGenrePills();
          await reloadRows();
        });
        genrePills.appendChild(b);
      });

      clearGenreBtn.onclick = async () => {
        state.genreId = null;
        clearGenreBtn.classList.add("hidden");
        renderGenrePills();
        await reloadRows();
      };
    }

    async function fetchDiscoverByGenre(genreId, page=1){
      const url = `${TMDB_BASE}/discover/movie?api_key=${TMDB_API_KEY}&with_genres=${encodeURIComponent(genreId)}&sort_by=popularity.desc&page=${page}`;
      return fetchJson(url);
    }

    // =========================
    // ROWS
    // =========================
    function createRowShell(title, key){
      const section = document.createElement("section");
      section.className = "space-y-3 opacity-0 translate-y-3 transition-all duration-500";
      section.innerHTML = `
        <div class="flex items-end justify-between gap-4">
          <div>
            <div class="text-[12px] uppercase tracking-[0.32em] text-slate-400">Collection</div>
            <h3 class="text-xl md:text-2xl font-bold tracking-tight">${esc(title)}</h3>
          </div>
          <div class="hidden md:flex items-center gap-2 text-sm text-textSofter">
            <span class="h-2 w-2 rounded-full bg-white/20"></span>
            <span>Scroll</span>
          </div>
        </div>
        <div id="row-${esc(key)}" class="row-scroll flex gap-4 overflow-x-auto pb-2 snap-x snap-mandatory"></div>
      `;
      rowsContainer.appendChild(section);

      // animate in
      requestAnimationFrame(() => {
        section.classList.remove("opacity-0","translate-y-3");
        section.classList.add("animate-fade-up");
      });

      return section.querySelector(`#row-${CSS.escape(key)}`);
    }

    function showRowSkeletons(){
      rowsContainer.innerHTML = "";
      for(let r=0;r<4;r++){
        const section = document.createElement("section");
        section.className = "space-y-3";
        section.innerHTML = `
          <div class="flex items-end justify-between">
            <div class="space-y-2">
              <div class="h-3 w-24 bg-white/10 rounded-full"></div>
              <div class="h-6 w-48 bg-white/10 rounded-full"></div>
            </div>
          </div>
          <div class="row-scroll flex gap-4 overflow-x-auto pb-2">
            ${new Array(8).fill(0).map(()=>`
              <div class="flex-shrink-0 w-[140px] sm:w-[160px] md:w-[180px] lg:w-[200px]">
                <div class="rounded-4xl bg-white/5 border border-white/10 overflow-hidden">
                  <div class="w-full aspect-[2/3] bg-white/10 relative overflow-hidden">
                    <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/10 to-transparent animate-shine"></div>
                  </div>
                </div>
              </div>
            `).join("")}
          </div>
        `;
        rowsContainer.appendChild(section);
      }
    }

    async function loadRows(){
      showRowSkeletons();

      if(state.genreId){
        // genre mode: build a few discover-based rows
        const g = state.genres.find(x => x.id === state.genreId);
        const label = g ? g.name : "Selected genre";
        setStatus(`Showing: ${label}`, true);

        // three themed rows
        const [d1, d2] = await Promise.all([
          fetchDiscoverByGenre(state.genreId, 1),
          fetchDiscoverByGenre(state.genreId, 2),
        ]);

        rowsContainer.innerHTML = "";

        const row1 = createRowShell(`Trending in ${label}`, "genre_1");
        (d1.results || []).slice(0, 16).forEach(m => row1.appendChild(createPosterCard(m)));

        const row2 = createRowShell(`More ${label} picks`, "genre_2");
        (d2.results || []).slice(0, 16).forEach(m => row2.appendChild(createPosterCard(m)));

        const popular = await fetchJson(`${TMDB_BASE}/movie/popular?api_key=${TMDB_API_KEY}&page=1`);
        const row3 = createRowShell(`Popular right now`, "genre_pop");
        (popular.results || []).slice(0, 16).forEach(m => row3.appendChild(createPosterCard(m)));

        return;
      }

      // normal mode
      setStatus("", false);
      const results = await Promise.all(CATEGORIES.map(async (c) => {
        const url = `${TMDB_BASE}${c.path}?api_key=${TMDB_API_KEY}&page=1`;
        const data = await fetchJson(url);
        return { c, data };
      }));

      rowsContainer.innerHTML = "";
      results.forEach(({c, data}) => {
        const row = createRowShell(c.title, c.key);
        (data.results || []).slice(0, 18).forEach(m => row.appendChild(createPosterCard(m)));
      });
    }

    async function reloadRows(){
      try{
        await loadRows();
      } catch (e){
        console.error(e);
        setStatus("Failed to load rows. Try refreshing.", true);
      }
    }

    // =========================
    // DETAILS MODAL
    // =========================
    function openModal(){
      detailsModal.classList.remove("hidden");
      document.body.classList.add("overflow-hidden");
      detailsModal.classList.add("animate-fade-in");
    }

    function closeModal(){
      detailsModal.classList.add("hidden");
      document.body.classList.remove("overflow-hidden");
    }

    modalClose.addEventListener("click", closeModal);
    modalBackdrop.addEventListener("click", closeModal);
    window.addEventListener("keydown", (e) => { if(e.key === "Escape") closeModal(); });

    function castChip(person){
      const img = person.profile_path ? IMG_W500 + person.profile_path : "";
      const name = person.name || "Unknown";
      const role = person.character || "";
      const el = document.createElement("div");
      el.className = "flex items-center gap-3 px-3 py-2 rounded-full bg-white/5 border border-white/10";
      el.innerHTML = `
        <div class="h-10 w-10 rounded-full overflow-hidden bg-white/10 border border-white/10 flex-shrink-0">
          ${img ? `<img src="${img}" class="w-full h-full object-cover" alt="${esc(name)}"/>` : ""}
        </div>
        <div class="leading-tight">
          <div class="text-sm font-semibold">${esc(name)}</div>
          <div class="text-[11px] text-textSofter">${esc(role)}</div>
        </div>
      `;
      return el;
    }

    async function openDetails(movieId){
      openModal();
      modalTitle.textContent = "Loading…";
      modalMeta.textContent = "";
      modalOverview.textContent = "";
      modalCast.innerHTML = "";
      modalSimilar.innerHTML = "";
      modalPoster.src = "";
      modalHeroBg.style.backgroundImage = "";

      try{
        const url = `${TMDB_BASE}/movie/${movieId}?api_key=${TMDB_API_KEY}&append_to_response=credits,similar`;
        const data = await fetchJson(url);

        const bg = data.backdrop_path ? IMG_ORIG + data.backdrop_path : "";
        const poster = data.poster_path ? IMG_W500 + data.poster_path : "";

        modalHeroBg.style.backgroundImage = bg ? `url(${bg})` : "none";
        modalPoster.src = poster || "https://via.placeholder.com/400x600/0b1020/ffffff?text=No+Image";

        modalTitle.textContent = data.title || "Untitled";

        const bits = [];
        if(data.vote_average) bits.push(`★ ${Number(data.vote_average).toFixed(1)}`);
        if(data.release_date) bits.push(data.release_date.split("-")[0]);
        if(data.runtime) bits.push(`${data.runtime} min`);
        if(Array.isArray(data.genres) && data.genres.length) bits.push(data.genres.slice(0,3).map(g=>g.name).join(", "));
        modalMeta.textContent = bits.join("  •  ");

        modalOverview.textContent = data.overview || "";

        modalPlayBtn.onclick = () => goToWatchMovie(movieId);
        modalWatchlistBtn.textContent = watchlistLabel(movieId);
        modalWatchlistBtn.onclick = () => {
          toggleWatchlist(movieId);
          modalWatchlistBtn.textContent = watchlistLabel(movieId);
          // also update hero buttons if needed
          heroAWatchlist.textContent = watchlistLabel(Number(heroAWatchlist.dataset?.id || movieId));
        };

        const cast = (data.credits && data.credits.cast) ? data.credits.cast.slice(0, 10) : [];
        cast.forEach(p => modalCast.appendChild(castChip(p)));

        const sim = (data.similar && data.similar.results) ? data.similar.results.slice(0, 14) : [];
        sim.forEach(m => modalSimilar.appendChild(createPosterCard(m)));

      } catch (e){
        console.error(e);
        modalTitle.textContent = "Failed to load details";
        modalOverview.textContent = "Try again in a moment.";
      }
    }

    // =========================
    // SEARCH
    // =========================
    async function handleSearch(q){
      const query = (q || "").trim();
      if(!query){
        searchSection.classList.add("hidden");
        searchRow.innerHTML = "";
        return;
      }
      try{
        setStatus("Searching…", true);
        const url = `${TMDB_BASE}/search/movie?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(query)}&page=1`;
        const data = await fetchJson(url);

        searchRow.innerHTML = "";
        const results = data.results || [];
        searchTitle.textContent = results.length ? `Results for “${query}”` : `No results for “${query}”`;

        results.slice(0, 18).forEach(m => searchRow.appendChild(createPosterCard(m)));
        searchSection.classList.remove("hidden");
        setStatus("", false);
      } catch (e){
        console.error(e);
        setStatus("Search failed. Try again.", true);
      }
    }

    if(searchForm && searchInput){
      searchForm.addEventListener("submit", (e) => {
        e.preventDefault();
        handleSearch(searchInput.value);
      });
    }

    if(mobileSearchBtn){
      mobileSearchBtn.addEventListener("click", () => {
        const q = prompt("Search movies:");
        if(q !== null) handleSearch(q);
      });
    }

    if(clearSearchBtn){
      clearSearchBtn.addEventListener("click", () => {
        if(searchInput) searchInput.value = "";
        searchSection.classList.add("hidden");
        searchRow.innerHTML = "";
      });
    }

    // =========================
    // INIT
    // =========================
    async function init(){
      loadWatchlist();

      try{
        // genres
        const genresData = await fetchJson(`${TMDB_BASE}/genre/movie/list?api_key=${TMDB_API_KEY}`);
        state.genres = (genresData.genres || []).slice(0, 18); // keep pills manageable
        renderGenrePills();

        // trending for hero
        const tr = await fetchJson(`${TMDB_BASE}/trending/movie/week?api_key=${TMDB_API_KEY}`);
        state.trending = (tr.results || []).slice(0, 16);
        renderHeroes();
        startHeroAutoRotate();

        // rows
        await loadRows();

        hideLoader();
      } catch (e){
        console.error(e);
        setStatus("Failed to load movies. Refresh and try again.", true);
        hideLoader();
      }
    }

    init();
  </script>
</body>
</html>
